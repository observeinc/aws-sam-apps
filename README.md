# SAM test

## Cloudformation Quick-Create Links

| Collection | Config | Forwarder |
|------------|--------|-----------|
| [![Static Badge](https://img.shields.io/badge/ap_south_1-latest-blue?logo=amazonaws)](https://ap-south-1.console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/create/review?templateURL=https://observeinc-ap-south-1.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/ap_south_1-latest-blue?logo=amazonaws)](https://ap-south-1.console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/create/review?templateURL=https://observeinc-ap-south-1.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/ap_south_1-latest-blue?logo=amazonaws)](https://ap-south-1.console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/create/review?templateURL=https://observeinc-ap-south-1.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/eu_north_1-latest-blue?logo=amazonaws)](https://eu-north-1.console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/create/review?templateURL=https://observeinc-eu-north-1.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/eu_north_1-latest-blue?logo=amazonaws)](https://eu-north-1.console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/create/review?templateURL=https://observeinc-eu-north-1.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/eu_north_1-latest-blue?logo=amazonaws)](https://eu-north-1.console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/create/review?templateURL=https://observeinc-eu-north-1.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/eu_west_3-latest-blue?logo=amazonaws)](https://eu-west-3.console.aws.amazon.com/cloudformation/home?region=eu-west-3#/stacks/create/review?templateURL=https://observeinc-eu-west-3.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/eu_west_3-latest-blue?logo=amazonaws)](https://eu-west-3.console.aws.amazon.com/cloudformation/home?region=eu-west-3#/stacks/create/review?templateURL=https://observeinc-eu-west-3.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/eu_west_3-latest-blue?logo=amazonaws)](https://eu-west-3.console.aws.amazon.com/cloudformation/home?region=eu-west-3#/stacks/create/review?templateURL=https://observeinc-eu-west-3.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/eu_west_2-latest-blue?logo=amazonaws)](https://eu-west-2.console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/create/review?templateURL=https://observeinc-eu-west-2.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/eu_west_2-latest-blue?logo=amazonaws)](https://eu-west-2.console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/create/review?templateURL=https://observeinc-eu-west-2.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/eu_west_2-latest-blue?logo=amazonaws)](https://eu-west-2.console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/create/review?templateURL=https://observeinc-eu-west-2.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/eu_west_1-latest-blue?logo=amazonaws)](https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://observeinc-eu-west-1.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/eu_west_1-latest-blue?logo=amazonaws)](https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://observeinc-eu-west-1.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/eu_west_1-latest-blue?logo=amazonaws)](https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://observeinc-eu-west-1.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/ap_northeast_3-latest-blue?logo=amazonaws)](https://ap-northeast-3.console.aws.amazon.com/cloudformation/home?region=ap-northeast-3#/stacks/create/review?templateURL=https://observeinc-ap-northeast-3.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/ap_northeast_3-latest-blue?logo=amazonaws)](https://ap-northeast-3.console.aws.amazon.com/cloudformation/home?region=ap-northeast-3#/stacks/create/review?templateURL=https://observeinc-ap-northeast-3.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/ap_northeast_3-latest-blue?logo=amazonaws)](https://ap-northeast-3.console.aws.amazon.com/cloudformation/home?region=ap-northeast-3#/stacks/create/review?templateURL=https://observeinc-ap-northeast-3.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/ap_northeast_2-latest-blue?logo=amazonaws)](https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/create/review?templateURL=https://observeinc-ap-northeast-2.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/ap_northeast_2-latest-blue?logo=amazonaws)](https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/create/review?templateURL=https://observeinc-ap-northeast-2.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/ap_northeast_2-latest-blue?logo=amazonaws)](https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/create/review?templateURL=https://observeinc-ap-northeast-2.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/ap_northeast_1-latest-blue?logo=amazonaws)](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://observeinc-ap-northeast-1.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/ap_northeast_1-latest-blue?logo=amazonaws)](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://observeinc-ap-northeast-1.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/ap_northeast_1-latest-blue?logo=amazonaws)](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://observeinc-ap-northeast-1.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/ca_central_1-latest-blue?logo=amazonaws)](https://ca-central-1.console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/create/review?templateURL=https://observeinc-ca-central-1.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/ca_central_1-latest-blue?logo=amazonaws)](https://ca-central-1.console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/create/review?templateURL=https://observeinc-ca-central-1.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/ca_central_1-latest-blue?logo=amazonaws)](https://ca-central-1.console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/create/review?templateURL=https://observeinc-ca-central-1.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/sa_east_1-latest-blue?logo=amazonaws)](https://sa-east-1.console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/create/review?templateURL=https://observeinc-sa-east-1.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/sa_east_1-latest-blue?logo=amazonaws)](https://sa-east-1.console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/create/review?templateURL=https://observeinc-sa-east-1.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/sa_east_1-latest-blue?logo=amazonaws)](https://sa-east-1.console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/create/review?templateURL=https://observeinc-sa-east-1.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/ap_southeast_1-latest-blue?logo=amazonaws)](https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create/review?templateURL=https://observeinc-ap-southeast-1.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/ap_southeast_1-latest-blue?logo=amazonaws)](https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create/review?templateURL=https://observeinc-ap-southeast-1.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/ap_southeast_1-latest-blue?logo=amazonaws)](https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create/review?templateURL=https://observeinc-ap-southeast-1.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/ap_southeast_2-latest-blue?logo=amazonaws)](https://ap-southeast-2.console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/create/review?templateURL=https://observeinc-ap-southeast-2.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/ap_southeast_2-latest-blue?logo=amazonaws)](https://ap-southeast-2.console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/create/review?templateURL=https://observeinc-ap-southeast-2.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/ap_southeast_2-latest-blue?logo=amazonaws)](https://ap-southeast-2.console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/create/review?templateURL=https://observeinc-ap-southeast-2.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/eu_central_1-latest-blue?logo=amazonaws)](https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?templateURL=https://observeinc-eu-central-1.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/eu_central_1-latest-blue?logo=amazonaws)](https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?templateURL=https://observeinc-eu-central-1.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/eu_central_1-latest-blue?logo=amazonaws)](https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?templateURL=https://observeinc-eu-central-1.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/us_east_1-latest-blue?logo=amazonaws)](https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://observeinc-us-east-1.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/us_east_1-latest-blue?logo=amazonaws)](https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://observeinc-us-east-1.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/us_east_1-latest-blue?logo=amazonaws)](https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://observeinc-us-east-1.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/us_east_2-latest-blue?logo=amazonaws)](https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/create/review?templateURL=https://observeinc-us-east-2.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/us_east_2-latest-blue?logo=amazonaws)](https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/create/review?templateURL=https://observeinc-us-east-2.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/us_east_2-latest-blue?logo=amazonaws)](https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/create/review?templateURL=https://observeinc-us-east-2.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/us_west_1-latest-blue?logo=amazonaws)](https://us-west-1.console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/create/review?templateURL=https://observeinc-us-west-1.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/us_west_1-latest-blue?logo=amazonaws)](https://us-west-1.console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/create/review?templateURL=https://observeinc-us-west-1.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/us_west_1-latest-blue?logo=amazonaws)](https://us-west-1.console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/create/review?templateURL=https://observeinc-us-west-1.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |
| [![Static Badge](https://img.shields.io/badge/us_west_2-latest-blue?logo=amazonaws)](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?templateURL=https://observeinc-us-west-2.s3.amazonaws.com/apps/collection/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/us_west_2-latest-blue?logo=amazonaws)](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?templateURL=https://observeinc-us-west-2.s3.amazonaws.com/apps/config/latest/packaged.yaml) | [![Static Badge](https://img.shields.io/badge/us_west_2-latest-blue?logo=amazonaws)](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?templateURL=https://observeinc-us-west-2.s3.amazonaws.com/apps/forwarder/latest/packaged.yaml) |

## Testing

The codebase looks like a standard golang project, so all the standard Go tooling should just work, e.g:

```
→ go test ./...
ok      github.com/observeinc/aws-sam-testing/cmd/ec2   (cached)
?       github.com/observeinc/aws-sam-testing/model/aws/ec2     [no test files]
?       github.com/observeinc/aws-sam-testing/model/aws/ec2/marshaller  [no test files]
ok      github.com/observeinc/aws-sam-testing/cmd/hello-world   (cached)
```

## Building and deploying

Each AWS SAM template lives under `apps/`. You can use the `sam` cli to build, invoke and deploy the cloudformation stack for testing.

```
→ cd apps/hello-world
→ sam build
Starting Build use cache
Valid cache found, copying previously built resources for following functions (HelloWorldFunction)

Build Succeeded

Built Artifacts  : .aws-sam/build
Built Template   : .aws-sam/build/template.yaml
```

## Publishing apps

Each SAM app can be packaged and published to the AWS Serverless Application Repository.

1. Bump the `SemanticVersion` in `template.yaml`:

```
Metadata:
  AWS::ServerlessRepo::Application:
    Name: hello-world-thing
    Description: A hello world
    Author: Observe Inc
    SpdxLicenseId: Apache-2.0
    ReadmeUrl: README.md
    HomePageUrl: https://github.com/observeinc/aws-sam-testing
    SemanticVersion: 0.0.2
    SourceCodeUrl: https://github.com/observeinc/aws-sam-testing
```

2. Package the template:

```
→ sam package --template-file template.yaml --output-template-file output.yaml

                Managed S3 bucket: aws-sam-cli-managed-default-samclisourcebucket-1d9p458evhgwf
                A different default S3 bucket can be set in samconfig.toml
                Or by specifying --s3-bucket explicitly.
File with same data already exists at 410049026555143131a24cfafb8eb862, skipping upload
        Uploading to bae5b6e5768f0a6e85e1b9c52dddcead  1021 / 1021  (100.00%)

Successfully packaged artifacts and wrote output template to file output.yaml.
Execute the following command to deploy the packaged template
sam deploy --template-file /Users/joao/Code/aws-sam-testing/apps/hello-world/output.yaml --stack-name <YOUR STACK NAME>
```

3. Publish the packaged template (`sam publish --template output.yaml`)

```
→ sam publish --template output.yaml

Publish Succeeded
The following metadata of application "arn:aws:serverlessrepo:us-west-2:739672403694:applications/hello-world-thing" has been updated:
{
  "Description": "A hello world",
  "Author": "Observe Inc",
  "ReadmeUrl": "s3://aws-sam-cli-managed-default-samclisourcebucket-1d9p458evhgwf/410049026555143131a24cfafb8eb862",
  "HomePageUrl": "https://github.com/observeinc/aws-sam-testing",
  "SemanticVersion": "0.0.2",
  "SourceCodeUrl": "https://github.com/observeinc/aws-sam-testing"
}
Click the link below to view your application in AWS console:
https://console.aws.amazon.com/serverlessrepo/home?region=us-west-2#/published-applications/arn:aws:serverlessrepo:us-west-2:739672403694:applications~hello-world-thing
```
## Release Workflow

Our release process is automated using GitHub Actions, ensuring consistency and reliability in each release.

### Release Steps

1. **Pre-release (Beta Releases on `main` branch):**
   Whenever changes are pushed to the `main` branch, our automated workflow triggers a beta release. This provides early access versions for testing and validation purposes.

2. **Full Release (Manual Trigger):**
   For creating an official release, manually trigger the release workflow from the GitHub Actions interface. This performs a full release.

3. **AWS SAM Build & Deployment:**
   - The AWS SAM application is built once at the beginning of the release phase to ensure consistency across regions.
   - AWS SAM resources are packaged and deployed across multiple AWS regions, specified in the `REGIONS` variable of our Makefile.

Upon each release, the SAM applications and their associated artifacts are packaged and uploaded to our S3 buckets. The naming convention and directory structure for these buckets are as follows:

```
observeinc-$REGION/apps/$APP/$VERSION/packaged.yaml
observeinc-$REGION/apps/$APP/latest/packaged.yaml
observeinc-$REGION/apps/$APP/beta/packaged.yaml
```

For instance:

For the collection app, version 1.0.1 being deployed to the us-west-1 region, the artifact would be located at:
observeinc-us-west-1/apps/collection/1.0.1/packaged.yaml

For the latest version of the same app in the same region:
observeinc-us-west-1/apps/collection/latest/packaged.yaml

For the beta version of the same app in the same region:
observeinc-us-west-1/apps/collection/beta/packaged.yaml

### Notes

- All semantic versioning is handled automatically by the `semantic-release` tool. This determines the version number based on the commit messages since the last release.
  
- Always ensure commit messages adhere to the [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/) standard, as our release tooling relies on this format.

- For region-specific AWS SAM builds or configurations, check the build artifacts located in `.aws-sam/build/<REGION_NAME>/`.
